// ==============================================================
// ARCHIVO: src/server.js - CON WEBSOCKET + SISTEMA DE PAGOS + COTIZACIONES
// ==============================================================

require('dotenv').config();

// Clear require cache to force reload
delete require.cache[require.resolve('./app')];

const app = require('./app');
const http = require('http');
const webSocketService = require('./services/websocketService');
const fs = require('fs');
const path = require('path');

const PORT = process.env.PORT || 5000;

async function startServer() {
    try {
        console.log('\nðŸŽ‰ ITOBOX Courier Backend INICIADO EXITOSAMENTE!');
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        console.log(`ðŸ“ Servidor: http://0.0.0.0:${PORT}`);
        console.log(`ðŸŒ Entorno: ${process.env.NODE_ENV || 'development'}`);
        console.log(`ðŸ“Š Health Check: http://0.0.0.0:${PORT}/api/health`);
        console.log('ðŸ”— ENDPOINTS COURIER:');
        console.log('   âœ… GET  /api/packages                  - GestiÃ³n de paquetes');
        console.log('   âœ… GET  /api/packages/stats            - EstadÃ­sticas de paquetes');
        console.log('   âœ… GET  /api/couriers                  - Red de couriers');
        console.log('   âœ… GET  /api/couriers/stats            - EstadÃ­sticas de couriers');
        console.log('   âœ… GET  /api/clients                   - Portal de clientes');
        console.log('   âœ… GET  /api/clients/stats             - EstadÃ­sticas de clientes');
        console.log('   âœ… GET  /api/dashboard/stats           - Dashboard completo');
        console.log('   âœ… PUT  /api/packages/:id/assign-courier - Asignar couriers');
        console.log('ðŸ’³ ENDPOINTS DE PAGOS:');
        console.log('   âœ… POST /api/payments/confirm-sinpe    - Confirmar pago SINPE');
        console.log('   âœ… POST /api/payments/confirm-paypal   - Confirmar pago PayPal');
        console.log('   âœ… POST /api/payments/confirm-bank-transfer - Transferencia bancaria');
        console.log('   âœ… GET  /api/payments/payment-methods  - MÃ©todos disponibles');
        console.log('   âœ… GET  /api/payments/payment-status/:id - Estado de pago');
        console.log('ðŸ’° NUEVOS ENDPOINTS DE COTIZACIONES:');
        console.log('   âœ… POST /api/quotes                    - Crear cotizaciÃ³n');
        console.log('   âœ… GET  /api/quotes                    - Listar cotizaciones');
        console.log('   âœ… GET  /api/quotes/:id                - Ver cotizaciÃ³n');
        console.log('   âœ… PUT  /api/quotes/:id/status         - Cambiar estado');
        console.log('   âœ… GET  /api/quotes/stats              - EstadÃ­sticas');
        console.log('ðŸ”Œ WebSocket para tracking en tiempo real');
        console.log('ðŸ“ Upload de comprobantes: /uploads/payment-receipts/');
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        
        // Crear directorio para recibos de pago si no existe
        const uploadDir = path.join(__dirname, '../uploads/payment-receipts');
        if (!fs.existsSync(uploadDir)) {
            fs.mkdirSync(uploadDir, { recursive: true });
            console.log('ðŸ“ Directorio de recibos creado: ', uploadDir);
        }

        // Crear servidor HTTP
        const server = http.createServer(app);
        
        // Inicializar WebSocket
        webSocketService.initialize(server);
        
        // Servir archivos estÃ¡ticos de recibos (solo para admin)
        app.use('/uploads', (req, res, next) => {
            // AquÃ­ puedes agregar middleware de autenticaciÃ³n si es necesario
            next();
        }, require('express').static(path.join(__dirname, '../uploads')));

        // AGREGAR RUTAS DE PAGOS

         // â­ FUNCIONES GLOBALES PARA NOTIFICACIONES DE COTIZACIONES
        global.notifyQuoteUpdate = function(quoteId, event, data) {
            try {
                if (webSocketService && webSocketService.broadcast) {
                    webSocketService.broadcast('quote_updated', {
                        quoteId,
                        event,
                        data,
                        timestamp: new Date().toISOString()
                    });
                    console.log(`ðŸ“¡ NotificaciÃ³n de cotizaciÃ³n enviada: ${quoteId} - ${event}`);
                }
            } catch (error) {
                console.error('âŒ Error enviando notificaciÃ³n de cotizaciÃ³n:', error);
            }
        };
        
        server.listen(PORT, '0.0.0.0', () => {
            console.log(`ðŸš€ Servidor courier + pagos + cotizaciones funcionando en puerto ${PORT}`);
            console.log(`ðŸ“¦ Test inmediato: curl http://localhost:${PORT}/api/packages`);
            console.log(`ðŸ“Š Dashboard stats: curl http://localhost:${PORT}/api/dashboard/stats`);
            console.log(`ðŸ’³ Test pagos: curl http://localhost:${PORT}/api/payments/payment-methods`);
            console.log(`ðŸ’° Test cotizaciones: curl http://localhost:${PORT}/api/quotes`);
            console.log(`ðŸ”Œ WebSocket disponible en ws://localhost:${PORT}`);
            console.log(`ðŸ“ Test WebSocket desde navegador (F12 > Console):`);
            console.log(`   const ws = new WebSocket('ws://localhost:${PORT}');`);
            console.log(`   ws.onopen = () => console.log('Conectado');`);
            console.log('\nðŸ’¡ CONFIGURACIÃ“N REQUERIDA EN .env:');
            console.log('   COMPANY_SINPE_PHONE=8888-8888');
            console.log('   COMPANY_BANK_NAME=Banco de Costa Rica');
            console.log('   COMPANY_ACCOUNT_NUMBER=001-0123456-7');
            console.log('   PAYPAL_CLIENT_ID=tu_paypal_client_id (opcional)');
            console.log('   DB_HOST=localhost');
            console.log('   DB_USER=root');
            console.log('   DB_PASSWORD=Siccosa$742');
            console.log('   DB_NAME=itobox_courier');
        });
        
    } catch (error) {
        console.error('âŒ Error iniciando servidor:', error);
        process.exit(1);
    }
}

// Manejo de errores no capturados
process.on('uncaughtException', (error) => {
    console.error('Uncaught Exception:', error);
    process.exit(1);
});

process.on('unhandledRejection', (reason, promise) => {
    console.error('Unhandled Rejection at:', promise, 'reason:', reason);
    process.exit(1);
});

// Manejo de seÃ±ales de terminaciÃ³n
process.on('SIGTERM', () => {
    console.log('SIGTERM received, shutting down gracefully');
    // Cerrar WebSocket connections antes de terminar
    if (webSocketService.wss) {
        webSocketService.wss.close();
    }
    process.exit(0);
});

process.on('SIGINT', () => {
    console.log('\nSIGINT received, shutting down gracefully');
    // Cerrar WebSocket connections antes de terminar
    if (webSocketService.wss) {
        webSocketService.wss.close();
    }
    process.exit(0);
});

// Exportar webSocketService para usar en rutas
app.webSocketService = webSocketService;

startServer();
